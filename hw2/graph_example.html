<!DOCTYPE html>
<meta charset="utf-8">
<title>Homework 2 Graph</title>
<style>
  .link {
    stroke: gray;
    stroke-width: .8px;
  }

  .node {
    fill: white;
    stroke: #000;
    stroke-width: .9px;
  }

  .node:hover {
    fill: black;
  }

  .text {
    color: #000;
    font-family: "Times New Roman", Georgia, Serif;
    font-size: 11px;
  }

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
  <form>
  Layout:
    <label><input type="radio" name="layout" value="force" checked> Force</label>
    <label><input type="radio" name="layout" value="random" > Random</label>
    <label><input type="radio" name="layout" value="circular"> Circular</label>  
    <label><input type="radio" name="layout" value="line"> Line</label>
    <label><input type="radio" name="layout" value="line_cat"> Line by Category</label>
  </form>
  <form>
  Color:
    <label><input type="radio" name="color" value="nocolor" checked> None</label>
    <label><input type="radio" name="color" value="color_cat" > Category</label>
  </form>
  <form>
  Size:
    <label><input type="radio" name="size" value="nosize" checked> None</label>
    <label><input type="radio" name="size" value="size_cat" > Category</label>
  </form>
  <form>
  Sort:
    <label><input type="radio" name="sort_by" value="sort_gdp" checked> GDP</label>
    <label><input type="radio" name="sort_by" value="sort_population" > Population</label>
  </form>
<script>

d3.json("data/countries_1995_2012.json", function(data) {

var margin = {top: 50, bottom: 10, left: 300, right: 40};
var width = 900 - margin.left - margin.right;
var height = 900 - margin.top - margin.bottom;

var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

var fill = d3.scale.category10();

var graph = {nodes: [], links: []};

var nb_nodes = 120, nb_cat = 10;

var node_scale = d3.scale.linear().domain([0, nb_cat]).range([5, 50])

var selected_year = 2012;

var sort_by = "gdp";

var accessor_selected_year_data = function(d) {
  year_data = [];
  d.years.forEach(function(m, i) {
    if (m.year == selected_year)
      year_data = m;
  });

  return year_data;
}

var accessor_population = function(d) {
  return accessor_selected_year_data(d).population;
}

var accessor_gdp = function(d) {
  return accessor_selected_year_data(d).gdp;
}



graph.nodes = data;
/*
graph.nodes.forEach(function(d, i) {
  d.years.forEach(function(y, j) {
    if(y.year == selected_year) {
      y.top_partners.forEach(function(p, k) {
        graph.links.push({"source": d.country_id, "target": p.country_id, "total_export": p.total_export});  
      });
      
    }
  })
})*/

// Generate the force layout
var force = d3.layout.force()
    .size([width, height])
    .charge(-50)
    .linkDistance(10)
    .on("tick", tick)
    .on("start", function(d) {})
    .on("end", function(d) {})

function tick(d) {
  graph_update(0);
}

function random_layout() {
  
  force.stop();

  graph.nodes.forEach(function(d, i) {
    d.x = width/4 + 2*width*Math.random()/4;
    d.y = height/4 + 2*height*Math.random()/4;
  })
  
  graph_update(500);
}

function force_layout() {

 force.nodes(graph.nodes)
      .links(graph.links)
      .start();
}

function line_layout() {

  force.stop();

  graph.nodes.forEach(function(d, i) {
    d.y = height/2;
  })

  graph_update(500);
}

function line_cat_layout() {

  force.stop();

  graph.nodes.forEach(function(d, i) {
    d.y = height/2 + d.cat*20;
  })

  graph_update(500);
}

function circular_layout() {

  force.stop();

  var r = Math.min(height, width)/2;

  var arc = d3.svg.arc()
          .outerRadius(r);

  var pie = d3.layout.pie()
          .sort(function(a, b) { 
          if (sort_by == "population")
            return accessor_population(a) - accessor_population(b);
          else
            return accessor_gdp(a) - accessor_gdp(b);
          }) // Sorting
          .value(function(d, i) { 
            return 1;  // We want an equal pie share/slice for each point
          });

  graph.nodes = pie(graph.nodes).map(function(d, i) {
    // Needed to caclulate the centroid
    d.innerRadius = 0;
    d.outerRadius = r;

    // Building the data object we are going to return
    d.data.x = arc.centroid(d)[0]+width/2;
    d.data.y = arc.centroid(d)[1]+height/2;

    return d.data;
  })

  graph_update(500);
}

function category_color() {

  d3.selectAll("circle").transition().duration(500)
                        .style("fill", function(d) { 
                          return fill(d.cat); 
                        });
}

function category_size() {

  d3.selectAll("circle").transition().duration(500)
                        .attr("r", function(d) { 
                          return Math.sqrt(node_scale(d.cat)); 
                        });
}

function graph_update(duration) {

  link.transition().duration(duration)
      .attr("x1", function(d) { return d.target.x; })
      .attr("y1", function(d) { return d.target.y; })
      .attr("x2", function(d) { return d.source.x; })
      .attr("y2", function(d) { return d.source.y; });

  node.transition().duration(duration)
      .attr("transform", function(d) { 
        return "translate("+d.x+","+d.y+")"; 
      });
}

d3.select("input[value=\"force\"]").on("click", force_layout);
d3.select("input[value=\"random\"]").on("click", random_layout);
d3.select("input[value=\"line\"]").on("click", line_layout);
d3.select("input[value=\"line_cat\"]").on("click", line_cat_layout);
d3.select("input[value=\"circular\"]").on("click", circular_layout);

d3.select("input[value=\"nocolor\"]").on("click", function() {
  d3.selectAll("circle").transition().duration(500).style("fill", "#66CC66");
})

d3.select("input[value=\"color_cat\"]").on("click", category_color);

d3.select("input[value=\"nosize\"]").on("click", function() {
  d3.selectAll("circle").transition().duration(500).attr("r", 5);
})

d3.select("input[value=\"size_cat\"]").on("click", category_size);

d3.select("input[value=\"sort_gdp\"]").on("click", function(){ sort_by = "gdp"; circular_layout(); });
d3.select("input[value=\"sort_population\"]").on("click", function(){ 
sort_by = "population"; 
circular_layout(); });


var link = svg.selectAll(".link")
              .data(graph.links);

link.enter().append("line")
    .attr("class", "link")

var node = svg.selectAll(".node")
              .data(graph.nodes)
            .enter()
              .append("g").attr("class", "node");

node.append("circle")
    .attr("r", 5)

node.append("text")
  .text(function (d) { return d.name;})
  .attr("x", 7)
  .attr("y", 3)
  .attr("class", "text");

force_layout();

});
</script>
</body>
</html>